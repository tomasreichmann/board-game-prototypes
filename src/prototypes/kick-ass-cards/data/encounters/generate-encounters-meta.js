import fs from "fs";
import path from "path";
import { globSync } from "glob";
import matter from "gray-matter";
import { fileURLToPath } from "url";

// Recreate __dirname for ES Modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const encountersDir = __dirname;

console.log(`üîç Scanning for MDX files in: ${encountersDir}`);

const globPattern = `${encountersDir.replace(/\\/g, "/")}/**/*.mdx`;
console.log(` glob pattern: ${globPattern}`);

const mdxFiles = globSync(globPattern, {
    ignore: `**/${path.basename(__filename)}`,
});

console.log(`üîé Found ${mdxFiles.length} MDX file(s) to process.`);

const encountersMap = {};

mdxFiles.forEach((file) => {
    const fileContent = fs.readFileSync(file, "utf8");
    const { data: frontmatter } = matter(fileContent);

    // If title is missing or empty, skip this file.
    if (!frontmatter.title || frontmatter.title.trim() === "") {
        console.log(`‚è© Skipping ${path.basename(file)}, title is missing or empty.`);
        return;
    }

    // Create a slug from the file path relative to the encounters directory
    const slug = path
        .relative(encountersDir, file)
        .replace(/\\/g, "/") // Ensure forward slashes for consistency
        .replace(".mdx", "");

    encountersMap[slug] = {
        slug: slug,
        path: slug,
        title: frontmatter.title,
        campaign: frontmatter.campaign ?? undefined,
        chapter: frontmatter.chapter ?? undefined,
        imageUri: frontmatter.imageUri ?? undefined,
    };
});

const outputFile = path.join(encountersDir, "encounters.generated.ts");

const content = `// This file is auto-generated by scripts/generate-encounters-meta.js
// Do not edit this file directly.

import { EncounterDefinition } from "./index";

export const encountersMap = ${JSON.stringify(encountersMap, null, 4)};
`;

fs.writeFileSync(outputFile, content, "utf8");

console.log(`‚úÖ Generated encounter metadata for ${Object.keys(encountersMap).length} files in ${outputFile}`);
